<!DOCTYPE html>
<html>
<head>
    <title>Scraper Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-failed { background-color: #f8d7da; color: #721c24; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-processing { background-color: #cce5ff; color: #004085; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">Scraper Dashboard</a>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>Submit New Scrape Task</h2>
                <form id="scrapeForm" class="row g-3">
                    <div class="col-auto flex-grow-1">
                        <input type="text" class="form-control" id="urlInput" placeholder="Enter URL to scrape" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">Submit Task</button>
                    </div>
                </form>
            </div>
            <div class="col-md-4">
                <h2>Quick Actions</h2>
                <a href="/admin/" class="btn btn-secondary">Admin Panel</a>
                <a href="http://localhost:5555" class="btn btn-info" target="_blank">Flower Dashboard</a>
            </div>
        </div>

        <h3>Recent Events</h3>
        <table id="eventsTable" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Pattern</th>
                    <th>Created At</th>
                    <th>Data Preview</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for event in recent_events %}
                <tr>
                    <td>{{ event.id }}</td>
                    <td>
                        <span class="badge bg-secondary">{{ event.pattern }}</span>
                    </td>
                    <td>{{ event.created_at|date:"Y-m-d H:i:s" }}</td>
                    <td>
                        <code>{{ event.data|truncatewords:15 }}</code>
                    </td>
                    <td>
                        {% if 'success' in event.data %}
                            <span class="status-badge status-success">Success</span>
                        {% elif 'error' in event.data %}
                            <span class="status-badge status-failed">Failed</span>
                        {% elif 'task_dispatched' in event.pattern %}
                            <span class="status-badge status-pending">Dispatched</span>
                        {% else %}
                            <span class="status-badge status-processing">Processing</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No events found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>Task Status Check</h3>
        <div class="row g-3 mb-4">
            <div class="col-auto flex-grow-1">
                <input type="text" class="form-control" id="taskIdInput" placeholder="Enter Task ID to check status">
            </div>
            <div class="col-auto">
                <button class="btn btn-info" onclick="checkTaskStatus()">Check Status</button>
            </div>
        </div>
        <div id="taskStatusResult" class="alert d-none"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function() {
            // Initialize DataTable
            $('#eventsTable').DataTable({
                "order": [[ 2, "desc" ]],
                "pageLength": 25
            });

            // Submit scrape form
            $('#scrapeForm').on('submit', function(e) {
                e.preventDefault();
                const url = $('#urlInput').val();

                $.ajax({
                    url: '{% url "submit_scrape" %}',
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({ url: url }),
                    success: function(response) {
                        alert(`Task submitted successfully!\nTask ID: ${response.task_id}`);
                        $('#urlInput').val('');
                        // Optionally, check status after submission
                        setTimeout(() => checkTaskStatusById(response.task_id), 2000);
                    },
                    error: function(xhr) {
                        alert(`Error: ${xhr.responseJSON.error}`);
                    }
                });
            });
        });

        function checkTaskStatus() {
            const taskId = $('#taskIdInput').val();
            if (!taskId) {
                alert('Please enter a Task ID');
                return;
            }
            checkTaskStatusById(taskId);
        }

        function checkTaskStatusById(taskId) {
            $.ajax({
                url: `/api/check-task/${taskId}/`,
                method: 'GET',
                success: function(response) {
                    const result = $('#taskStatusResult');
                    result.removeClass('d-none alert-success alert-danger alert-info');

                    if (response.status === 'SUCCESS') {
                        result.addClass('alert-success');
                        result.html(`
                            <h5>Task Status: SUCCESS</h5>
                            <pre>${JSON.stringify(response.result, null, 2)}</pre>
                        `);
                    } else if (response.status === 'FAILURE') {
                        result.addClass('alert-danger');
                        result.html(`
                            <h5>Task Status: FAILED</h5>
                            <p>${response.error}</p>
                        `);
                    } else {
                        result.addClass('alert-info');
                        result.html(`<h5>Task Status: ${response.status}</h5>`);
                    }
                },
                error: function(xhr) {
                    const result = $('#taskStatusResult');
                    result.removeClass('d-none').addClass('alert-danger');
                    result.html(`Error: ${xhr.responseJSON.error}`);
                }
            });
        }
    </script>
</body>
</html>